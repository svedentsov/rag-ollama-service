# --- Этап 1: Сборка проекта ---
# Используем официальный образ Gradle с нужной версией JDK.
FROM gradle:8.8-jdk21 AS build

# Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# Копируем файлы Gradle. Этот слой будет кэширован, если файлы сборки не изменятся,
# что ускоряет последующие сборки, т.к. зависимости не будут скачиваться заново.
COPY build.gradle settings.gradle ./

# Скачиваем все зависимости.
RUN gradle dependencies --no-daemon

# Копируем исходный код проекта
COPY src ./src

# Собираем приложение в исполняемый JAR-файл.
# Пропускаем тесты (-x test), так как их следует запускать отдельно в CI/CD пайплайне.
RUN gradle build -x test --no-daemon

# --- Этап 2: Запуск приложения ---
# Используем минималистичный образ с JRE.
FROM eclipse-temurin:21-jre-jammy

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем собранный JAR-файл из стадии 'build' в текущий образ.
# Gradle помещает артефакты в build/libs
COPY --from=build /app/build/libs/app.jar app.jar

# Сообщаем Docker, что контейнер будет слушать на порту 8080.
EXPOSE 8080

# Команда, которая будет выполнена при запуске контейнера.
ENTRYPOINT ["java", "-jar", "app.jar"]